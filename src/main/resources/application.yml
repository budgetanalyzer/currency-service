server:
  servlet:
    context-path: /currency-service
  port: 8084

logging:
  level:
    root: WARN
    com.bleurubin: TRACE
    org.springframework.web.reactive.function.client: DEBUG

spring:
  application:
    name: currency-service

  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 10MB

  jackson:
    default-property-inclusion: non_null
    serialization:
      indent-output: true           # Pretty print JSON
    date-format: com.fasterxml.jackson.databind.util.StdDateFormat

  datasource:
    url: jdbc:postgresql://localhost:5432/currency
    username: budget_analyzer
    password: budget_analyzer
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: validate  # Flyway manages schema, JPA validates it matches entities
    show-sql: false

  flyway:
    enabled: true
    locations: classpath:db/migration
    validate-on-migrate: true

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2
          max-wait: -1ms

  cache:
    type: redis
    redis:
      # TTL is managed in CacheConfig.java (set to infinite)
      # Exchange rates only change during imports, cache explicitly evicted via @CacheEvict
      time-to-live: 0  # 0 = no expiration
      cache-null-values: false
      use-key-prefix: true
      key-prefix: "currency-service:"

  cloud:
    function:
      definition: importExchangeRates  # Register consumer function
    stream:
      bindings:
        # Publisher binding
        currencyCreated-out-0:
          destination: currency.created

        # Consumer binding
        importExchangeRates-in-0:
          destination: currency.created
          group: exchange-rate-import-service

      rabbit:
        bindings:
          importExchangeRates-in-0:
            consumer:
              auto-bind-dlq: true              # Dead letter queue
              republish-to-dlq: true            # Preserve original message
              max-attempts: 3                   # Retry 3 times
              initial-interval: 1000            # 1 second initial retry delay
              max-interval: 10000               # 10 seconds max retry delay
              multiplier: 2.0                   # Exponential backoff

  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USERNAME:guest}
    password: ${RABBITMQ_PASSWORD:guest}

currency-service:
  exchange-rate-import:
    # Cron expression for when the job runs (default: 11 PM UTC / 6 PM EST)
    cron: "0 0 23 * * ?"
    import-on-startup: true  # Set to false to disable startup import

    # FRED API configuration
    fred:
      base-url: https://api.stlouisfed.org/fred
      api-key: ${FRED_API_KEY}

    # Retry configuration
    retry:
      # Maximum number of retry attempts (including initial attempt)
      # Example: max-attempts=3 means 1 initial + 2 retries
      max-attempts: 3
      # Delay between retries in minutes
      delay-minutes: 1

bleurubin:
  service:
    http-logging:
      enabled: true
      log-level: DEBUG
      include-request-body: true
      include-response-body: true
      max-body-size: 10000
      exclude-patterns:
        - /actuator/**
        - /swagger-ui/**
        - /v3/api-docs/**

server:
  servlet:
    context-path: /currency-service
  port: 8084

logging:
  level:
    root: WARN
    org.budgetanalyzer: TRACE
    org.springframework.web.reactive.function.client: DEBUG
    # Spring Cloud Stream / Integration / AMQP - INFO by default
    org.springframework.cloud.stream: INFO
    org.springframework.integration: INFO
    org.springframework.amqp: INFO
    # Specific DEBUG loggers for key components
    org.springframework.amqp.rabbit.core.RabbitTemplate: DEBUG
    org.springframework.modulith.events.core.DefaultEventPublicationRegistry: DEBUG

spring:
  application:
    name: currency-service

  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 10MB

  jackson:
    default-property-inclusion: non_null  # Exclude null fields from JSON
    serialization:
      indent-output: true                 # Pretty print JSON
      write-dates-as-timestamps: false    # Use ISO-8601 format for dates
    date-format: com.fasterxml.jackson.databind.util.StdDateFormat

  datasource:
    url: jdbc:postgresql://localhost:5432/currency
    username: budget_analyzer
    password: budget_analyzer
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: validate  # Flyway manages schema, JPA validates it matches entities
    show-sql: false

  flyway:
    enabled: true
    locations: classpath:db/migration
    validate-on-migrate: true

  security:
    oauth2:
      resourceserver:
        jwt:
          # Auth0 issuer URI (abstracted through NGINX /auth/.well-known/openid-configuration)
          # In production, this will point to NGINX gateway
          # In development, can point directly to Auth0 or through NGINX
          issuer-uri: ${AUTH0_ISSUER_URI:https://dev-gcz1r8453xzz0317.us.auth0.com/}
          # JWT audience validation - ensures token was issued for our API
          audiences:
            - ${AUTH0_AUDIENCE:https://api.budgetanalyzer.org}

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2
          max-wait: -1ms

  cache:
    type: redis
    redis:
      # TTL is managed in CacheConfig.java (set to infinite)
      # Exchange rates only change during imports, cache explicitly evicted via @CacheEvict
      time-to-live: 0  # 0 = no expiration
      cache-null-values: false
      use-key-prefix: true
      key-prefix: "currency-service:"

  cloud:
    function:
      definition: importExchangeRates  # Register consumer function
    stream:
      bindings:
        # Publisher binding
        currencyCreated-out-0:
          destination: currency.created

        # Consumer binding
        importExchangeRates-in-0:
          destination: currency.created
          group: exchange-rate-import-service

      rabbit:
        bindings:
          importExchangeRates-in-0:
            consumer:
              auto-bind-dlq: true              # Dead letter queue
              republish-to-dlq: true            # Preserve original message
              max-attempts: 3                   # Retry 3 times
              initial-interval: 1000            # 1 second initial retry delay
              max-interval: 10000               # 10 seconds max retry delay
              multiplier: 2.0                   # Exponential backoff

  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USERNAME:guest}
    password: ${RABBITMQ_PASSWORD:guest}

  # Spring Modulith event processing configuration
  modulith:
    events:
      # Republish outstanding events on application restart
      republish-outstanding-events-on-restart: true
      # Retain completed events for audit trail (30 days)
      delete-completion-after: 30d

  # Task execution configuration for async processing
  task:
    execution:
      pool:
        core-size: 5
        max-size: 10
        queue-capacity: 100
      thread-name-prefix: async-task-
      shutdown:
        await-termination: true
        await-termination-period: 60s
    scheduling:
      pool:
        size: 2
      thread-name-prefix: scheduler-
      shutdown:
        await-termination: true
        await-termination-period: 60s

currency-service:
  exchange-rate-import:
    # Cron expression for when the job runs (default: 11 PM UTC / 6 PM EST)
    cron: "0 0 23 * * ?"
    import-on-startup: true  # Set to false to disable startup import

    # FRED API configuration
    fred:
      base-url: https://api.stlouisfed.org/fred
      api-key: ${FRED_API_KEY}
      timeout-seconds: 30  # Timeout for FRED API requests

    # Retry configuration
    retry:
      # Maximum number of retry attempts (including initial attempt)
      # Example: max-attempts=3 means 1 initial + 2 retries
      max-attempts: 3
      # Delay between retries in minutes
      delay-minutes: 1

budgetanalyzer:
  service:
    http-logging:
      enabled: true
      log-level: DEBUG
      include-request-body: true
      include-response-body: true
      max-body-size: 10000
      exclude-patterns:
        - /**/actuator/**
        - /**/swagger-ui/**
        - /**/v3/api-docs/**
        - /**/v3/api-docs.yaml

logging:
  level:
    # Transaction lifecycle - shows begin/commit/rollback
    org.springframework.transaction: DEBUG
    org.springframework.orm.jpa: DEBUG

    # Hibernate - shows SQL execution and flush timing
    org.hibernate.SQL: DEBUG
    org.hibernate.engine.transaction: TRACE
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

    # Spring Modulith - shows event publication and completion
    org.springframework.modulith.events: TRACE
    org.springframework.modulith.events.core: TRACE
    org.springframework.modulith.events.support: TRACE

    # Async execution - shows thread pool activity
    org.springframework.scheduling.concurrent: DEBUG
    org.springframework.core.task: DEBUG

    # RabbitMQ - shows message delivery timing
    org.springframework.amqp.rabbit.listener: DEBUG
    org.springframework.amqp.rabbit.connection: DEBUG

spring:
  flyway:
    enabled: true
    locations: classpath:db/migration
    validate-on-migrate: false  # Disabled for TestContainers - container reused across tests with modified migrations
    clean-disabled: false  # Allow Flyway clean for tests
    connect-retries: 0

  data:
    redis:
      host: localhost
      port: 6379

  cache:
    type: none  # Default: no cache for most tests. Enable with @TestPropertySource for cache-specific tests

  # Task execution configuration for tests - disable wait on shutdown to prevent hanging
  task:
    execution:
      shutdown:
        await-termination: false
    scheduling:
      shutdown:
        await-termination: false

  cloud:
    function:
      definition: importExchangeRates  # Register consumer function
    stream:
      bindings:
        # Publisher binding
        currencyCreated-out-0:
          destination: currency.created

        # Consumer binding
        importExchangeRates-in-0:
          destination: currency.created
          # CRITICAL: Use unique group per test run to ensure fresh queues
          # This creates a queue like: currency.created.test-abc123-def456
          group: test-${random.uuid}
          # Additional isolation settings
          max-attempts: 3
          back-off-initial-interval: 1000
          back-off-multiplier: 2.0
          back-off-max-interval: 10000

      rabbit:
        bindings:
          importExchangeRates-in-0:
            consumer:
              auto-bind-dlq: true               # Dead letter queue
              republish-to-dlq: true            # Preserve original message
              max-attempts: 3                   # Retry 3 times
              initial-interval: 1000            # 1 second initial retry delay
              max-interval: 10000               # 10 seconds max retry delay
              multiplier: 2.0                   # Exponential backoff
              # Queue durability settings for tests
              # Use non-durable queues in tests for faster cleanup
              durable-subscription: false
              # Acknowledge mode
              acknowledge-mode: auto
              # Prefetch for testing
              prefetch: 1

  # Spring Modulith configuration for tests
  modulith:
    events:
      completion-mode: update  # Keep completed events in db for test verification
      republish-outstanding-events-on-restart: false  # Don't republish on test restart

  # HikariCP configuration for tests - fast failure to prevent 30s hangs on shutdown
  datasource:
    hikari:
      connection-timeout: 1000  # 1 second instead of default 30 seconds
      validation-timeout: 1000  # 1 second validation timeout
      initialization-fail-timeout: 0  # Fail fast if pool can't initialize
      maximum-pool-size: 2
      minimum-idle: 1

currency-service:
  exchange-rate-import:
    import-on-startup: false  # Disable startup import in tests
    fred:
      # base-url is set dynamically via @DynamicPropertySource in TestContainersConfiguration
      api-key: test-key
      timeout-seconds: 2  # Timeout for FRED API requests
    retry:
      max-attempts: 1
      delay-minutes: 1  # Minimum allowed value
